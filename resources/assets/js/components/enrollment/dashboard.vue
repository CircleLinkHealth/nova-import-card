<template>
    <div id="enrollment_calls">

        <ul class="side-nav fixed">

            <div class="row">
                <div class="col s6">
                    <div class="card">
                        <div class="card-content" style="text-align: center">
                            <div style="color: #6d96c5" class="counter">
                                {{report.total_calls ? report.total_calls : 0}}
                            </div>
                            <div class="card-subtitle">
                                Total Calls
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col s6">
                    <div class="card">
                        <div class="card-content" style="text-align: center">
                            <div style="color: #9fd05f" class="counter">
                                {{report.no_enrolled ? report.no_enrolled : 0}}
                            </div>
                            <div class="card-subtitle">
                                Enrolled
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content" style="text-align: center">
                            <div style="color: #6d96c5" class="counter">
                                {{formatted_total_time_in_system}}
                            </div>
                            <div class="card-subtitle">
                                Time worked
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <ul>
                                <li class="sidebar-demo-list"><span :title="name"><b>Name:</b>{{name}}</span></li>
                                <li class="sidebar-demo-list"><span :title="lang"><b>Language:</b> {{lang}}</span></li>
                                <li class="sidebar-demo-list"><span :title="providerFullName"><b>Provider Name:</b>{{providerFullName}}</span>
                                </li>
                                <li class="sidebar-demo-list"><span :title="practice_name"><b>Practice Name:</b>{{practice_name}}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <div class="row">

                                <div v-if="callError">
                                    <blockquote>Call Status: {{ callError }}</blockquote>
                                </div>

                                <div v-if="onCall === true" style="text-align: center">

                                    <blockquote>Call Status: {{ this.callStatus }}</blockquote>
                                    <a v-on:click="hangUp" class="waves-effect waves-light btn" style="background: red"><i
                                            class="material-icons left">call_end</i>Hang Up</a>
                                </div>
                                <div v-else style="text-align: center">
                                    <div v-if="home_phone !== ''" class="col s4">

                                        <div class="waves-effect waves-light btn call-button"
                                             v-on:click="call(home_phone, 'Home')">
                                            <i class="material-icons">phone</i>
                                        </div>
                                        <div>
                                            Home
                                        </div>

                                    </div>
                                    <div v-if="cell_phone !== ''" class="col s4">

                                        <div class="waves-effect waves-light btn call-button"
                                             v-on:click="call(cell_phone, 'Cell')">
                                            <i class="material-icons">phone</i>

                                        </div>
                                        <div>
                                            Cell
                                        </div>

                                    </div>
                                    <div v-if="other_phone !== ''" class="col s4">

                                        <div class="waves-effect waves-light btn call-button"
                                             v-on:click="call(other_phone, 'Other')">
                                            <i class="material-icons">phone</i>

                                        </div>

                                        <div>
                                            Other
                                        </div>


                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <ul class="action-buttons">
                                <li>
                                    <a class="waves-effect waves-light btn modal-trigger" href="#consented">
                                        Consented
                                    </a>
                                </li>
                                <li>
                                    <a class="waves-effect waves-light btn modal-trigger" href="#utc"
                                       style="background: #ecb70e">
                                        No Answer
                                    </a>
                                </li>
                                <li>
                                    <a class="waves-effect waves-light btn modal-trigger" href="#rejected"
                                       style="background: red;">
                                        Hard Declined
                                    </a>
                                </li>
                                <li>
                                    <a class="waves-effect waves-light btn modal-trigger" href="#rejected"
                                       v-on:click="softReject()"
                                       style="background: #ff0000c2;">
                                        Soft Declined
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </ul>

        <div style="margin-left: 26%;">

            <div style="padding: 0px 10px; font-size: 16px;">

                <blockquote v-if="last_call_outcome !== ''">
                    Last Call Outcome: {{ last_call_outcome }}
                    <span v-if="last_call_outcome_reason !== ''">
                        <br/>
                        Last Call Comment: {{ last_call_outcome_reason }}
                    </span>
                </blockquote>

                <div class="enrollment-script">

                    <template v-if="has_copay">
                        <template v-if="lang === 'EN'">
                            <copay-en :name="name" :user-full-name="userFullName" :provider-full-name="providerFullName"
                                      :practice-name="practice_name"></copay-en>
                        </template>
                        <template v-else>
                            <copay-es :name="name" :user-full-name="userFullName" :provider-full-name="providerFullName"
                                      :practice-name="practice_name"></copay-es>
                        </template>
                    </template>
                    <template v-else>
                        <template v-if="lang === 'EN'">
                            <no-copay-en :name="name" :user-full-name="userFullName"
                                         :provider-full-name="providerFullName"
                                         :practice-name="practice_name"></no-copay-en>
                        </template>
                        <template v-else>
                            <no-copay-es :name="name" :user-full-name="userFullName"
                                         :provider-full-name="providerFullName"
                                         :practice-name="practice_name"></no-copay-es>
                        </template>
                    </template>
                </div>
            </div>

            <div style="padding: 10px; margin-bottom: 15px"></div>
            <div style="text-align: center">

            </div>
        </div>

        <!-- MODALS -->

        <!-- Success / Patient Consented -->
        <div id="consented" class="modal confirm modal-fixed-footer consented_modal">
            <form method="post" id="consented_form" :action="consentedUrl">

                <input type="hidden" name="_token" :value="csrf">

                <div class="modal-content">
                    <h4 style="color: #47beab">Awesome! Please confirm patient details:</h4>
                    <blockquote style="border-left: 5px solid #26a69a;">
                        <span class="consented_title"><b>I.</b></span>

                        <b>Ask patient:</b>
                        <div class="enrollment-script">
                            <template v-if="lang === 'ES'">
                                ¿Quiere quele llamemos directamente o hay alguien más con el cual quiere quenos pongamos
                                en
                                contacto?
                            </template>
                            <template v-else>
                                Do you want us to call you directly or is there someone else we should contact?
                            </template>
                        </div>
                        <br>
                        <b>Use radio button to confirm patient's preferred phone number to receive care management
                            calls.</b>
                    </blockquote>
                    <div class="row">
                        <div class="col s6 m4 select-custom">
                            <input name="preferred_phone" type="radio" id="home_radio" value="home"
                                   :checked="home_phone != ''"/>
                            <label for="home_radio"
                                   :class="{valid: home_is_valid, invalid: home_is_invalid}">{{home_phone_label}}</label>
                            <input class="input-field" name="home_phone" id="home_phone" v-model="home_phone"/>
                        </div>
                        <div class="col s6 m4 select-custom">
                            <input name="preferred_phone" type="radio" id="cell_radio" value="cell"
                                   :checked="home_phone == '' && cell_phone != ''"/>
                            <label for="cell_radio"
                                   :class="{valid: cell_is_valid, invalid: cell_is_invalid}">{{cell_phone_label}}</label>
                            <input class="input-field" name="cell_phone" id="cell_phone" v-model="cell_phone"/>
                        </div>
                        <div class="col s6 m4 select-custom">
                            <input name="preferred_phone" type="radio" id="other_radio" value="other"
                                   :checked="home_phone == '' && cell_phone == '' && other_phone != ''"/>
                            <label for="other_radio"
                                   :class="{valid: other_is_valid, invalid: other_is_invalid}">{{other_phone_label}}</label>
                            <input class="input-field" name="other_phone" id="other_phone" v-model="other_phone"/>
                        </div>
                    </div>
                    <div class="row">
                        <blockquote style="border-left: 5px solid #26a69a;">
                            <span class="consented_title"><b>II.</b></span> Please confirm address and email
                        </blockquote>

                        <div class="col s12 m3 select-custom">
                            <label for="address" class="label">Address</label>
                            <input class="input-field" name="address" id="address" v-model="address"/>
                        </div>
                        <div class="col s12 m2 select-custom">
                            <label for="address_2" class="label">Address Line 2</label>
                            <input class="input-field" name="address_2" id="address_2" v-model="address_2"/>
                        </div>
                        <div class="col s12 m2 select-custom">
                            <label for="city" class="label">City</label>
                            <input class="input-field" name="city" id="city" v-model="city"/>
                        </div>
                        <div class="col s12 m1 select-custom">
                            <label for="state" class="label">State</label>
                            <input class="input-field" name="state" id="state" v-model="state"/>
                        </div>
                        <div class="col s12 m1 select-custom">
                            <label for="zip" class="label">Zip</label>
                            <input class="input-field" name="zip" id="zip" v-model="zip"/>
                        </div>
                        <div class="col s12 m3 select-custom">
                            <label for="email" class="label">Email</label>
                            <input class="input-field" name="email" id="email" v-model="email"/>
                        </div>
                    </div>
                    <div class="row">
                        <blockquote style="border-left: 5px solid #26a69a;">
                            <span class="consented_title"><b>III.</b></span> Please confirm the patient's preferred
                            contact days
                            and
                            times, and any other relevant information:
                        </blockquote>
                        <div class="col s12 m3">
                            <label for="days[]" class="label">Day</label>
                            <select name="days[]" id="days[]" multiple>
                                <option disabled selected>Days:</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                            </select>
                        </div>
                        <div class="col s12 m3">
                            <label for="times[]" class="label">Times</label>
                            <select name="times[]" id="times[]" multiple>
                                <option disabled selected>Times:</option>
                                <option value="10:00-12:00">10AM - Noon</option>
                                <option value="12:00-15:00">Noon - 3PM</option>
                                <option value="15:00-18:00">3PM - 6PM</option>
                            </select>
                        </div>
                        <div class="col s12 m6 select-custom">
                            <label for="extra" class="label">Optional additional information</label>
                            <input class="input-field" name="extra" id="extra"/>
                        </div>
                    </div>

                    <blockquote style="border-left: 5px solid #26a69a;">
                        <span class="consented_title"><b>IV.</b></span>
                        <span style="color: red"><b>TELL PATIENT BEFORE HANGING UP!</b></span><br>
                        <div class="enrollment-script">
                            <template v-if="lang === 'ES'">
                                Una enfermera registrada le llamará en breve del mismo desde el cual lo estoy llamando
                                {{practice_phone}}. Por favor, guárdelo para que acepte la llamada cuando suene el
                                teléfono.
                                ¡Me alegro de haberme conectado! ¡Que tenga un muy buen día!
                            </template>
                            <template v-else>
                                A Registered Nurse will call you shortly from the same # I’m calling from,
                                {{practice_phone}}.
                                Please save it so you accept the call when she/he rings. So glad we
                                connected! Have a great day!
                            </template>
                        </div>
                    </blockquote>

                    <input type="hidden" name="status" value="consented">
                    <input type="hidden" name="enrollee_id" :value="enrolleeId">
                    <input type="hidden" name="total_time_in_system" :value="total_time_in_system">
                    <input type="hidden" name="time_elapsed" :value="time_elapsed">

                </div>
                <div class="modal-footer">
                    <button name="submit" type="submit"
                            :disabled="home_is_invalid || cell_is_invalid || other_is_invalid"
                            class="modal-action waves-effect waves-light btn">Confirm and call next patient
                    </button>
                    <div v-if="onCall === true" style="text-align: center">
                        <a v-on:click="hangUp" class="waves-effect waves-light btn" style="background: red"><i
                                class="material-icons left">call_end</i>Hang Up</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Unable To Contact -->
        <div id="utc" class="modal confirm modal-fixed-footer">
            <form method="post" id="utc_form" :action="utcUrl">

                <input type="hidden" name="_token" :value="csrf">

                <div class="modal-content">
                    <h4 style="color: #47beab">Please provide some details:</h4>
                    <blockquote style="border-left: 5px solid #26a69a;">
                        <b>If Caller Reaches Machine, Leave Voice Message: </b><br>
                        Hi this is {{userFullName}} calling on
                        behalf of {{ providerFullName }} at {{ practice_name }}. The doctor[s] have invited you to their
                        new
                        personalized care management program. Please give us a call at {{practice_phone}} to learn more.
                        Please note there is
                        nothing to worry about, this program just lets the Dr. take better care of you between visits.
                        Again the number is {{practice_phone}}
                    </blockquote>

                    <div class="row">
                        <div class="col s12 m12">
                            <label for="utc-reason" class="label">Reason:</label>
                            <select v-model="utc_reason" name="reason" id="utc-reason" required>
                                <option value="voicemail">Left A Voicemail</option>
                                <option value="disconnected">Disconnected Number</option>
                                <option value="requested callback">Requested Call At Other Time</option>
                                <option value="other">Other...</option>
                            </select>
                        </div>

                        <div class="col s6 m12 select-custom">
                            <label for="utc_reason_other" class="label">If you selected other, please specify:</label>
                            <input class="input-field" name="reason_other" id="utc_reason_other"/>
                        </div>

                        <div v-show="utc_requested_callback" class="col s6 m12 select-custom">
                            <label for="utc_callback" class="label">Patient Requests Callback On:</label>
                            <input type="date" name="utc_callback" id="utc_callback">
                        </div>

                    </div>

                    <input type="hidden" name="status" value="utc">
                    <input type="hidden" name="enrollee_id" :value="enrolleeId">
                    <input type="hidden" name="total_time_in_system" v-bind:value="total_time_in_system">
                    <input type="hidden" name="time_elapsed" v-bind:value="time_elapsed">

                </div>
                <div class="modal-footer">
                    <button name="submit" type="submit"
                            class="modal-action waves-effect waves-light btn">Call Next Patient
                    </button>
                    <div v-if="onCall === true" style="text-align: center">
                        <a v-on:click="hangUp" class="waves-effect waves-light btn" style="background: red"><i
                                class="material-icons left">call_end</i>Hang Up</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Rejected -->
        <div id="rejected" class="modal confirm modal-fixed-footer">
            <form method="post" id="rejected_form" :action="rejectedUrl">

                <input type="hidden" name="_token" :value="csrf">

                <div class="modal-content">
                    <h4 style="color: #47beab">Please provide some details:</h4>

                    <div class="row">
                        <div class="col s12 m12">
                            <label for="reason" class="label">What reason did the Patient convey?</label>
                            <select name="reason" id="reason" required>
                                <option value="Worried about co-pay">Worried about co-pay</option>
                                <option value="Doesn’t trust medicare">Doesn’t trust medicare</option>
                                <option value="Doesn’t need help with Health">Doesn’t need help with Health</option>
                                <option value="other">Other...</option>
                            </select>
                        </div>

                        <div class="col s6 m12 select-custom">
                            <label for="rejected_reason_other" class="label">If you selected other, please
                                specify:</label>
                            <input class="input-field" name="reason_other" id="rejected_reason_other"/>
                        </div>

                        <div v-if="isSoftDecline" class="col s6 m12 select-custom">
                            <label for="soft_decline_callback" class="label">Patient Requests Callback On:</label>
                            <input type="date" name="soft_decline_callback" id="soft_decline_callback">
                            <input type="hidden" name="status" value="soft_rejected">
                        </div>
                        <div v-else>
                            <input type="hidden" name="status" value="rejected">
                        </div>

                    </div>


                    <input type="hidden" name="enrollee_id" :value="enrolleeId">
                    <input type="hidden" name="total_time_in_system" v-bind:value="total_time_in_system">
                    <input type="hidden" name="time_elapsed" v-bind:value="time_elapsed">

                </div>
                <div class="modal-footer" style="padding-right: 60px">
                    <button name="submit" type="submit"
                            class="modal-action waves-effect waves-light btn">Call Next Patient
                    </button>
                    <div v-if="onCall === true" style="text-align: center">
                        <a v-on:click="hangUp" class="waves-effect waves-light btn" style="background: red"><i
                                class="material-icons left">call_end</i>Hang Up</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Enrollment tips -->
        <div id="tips" class="modal confirm modal-fixed-footer">
            <div class="modal-content">
                <div class="row">
                    <div class="input-field col s12">
                        <h5>Tips</h5>
                        <br/>
                        <div v-html="enrollmentTips"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col s6">
                        <div style="margin-top: 10px; text-align: left">
                            <label for="do-not-show-tips-again">
                                <input id="do-not-show-tips-again"
                                       name="do-not-show-tips-again"
                                       class="filled-in"
                                       type="checkbox" @click="doNotShowTipsAgain"/>
                                <span>Do not show again</span>
                            </label>
                        </div>
                    </div>
                    <div class="col s6">
                        <button type="button"
                                data-dismiss="modal" aria-label="Got it!"
                                class="modal-close waves-effect waves-light btn">
                            Got it!
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </div>
</template>

<script>

    import Twilio from 'twilio-client';

    import {rootUrl} from '../../app.config';
    import CoPayEn from './call-scripts/copay-en';
    import NoCoPayEn from './call-scripts/no-copay-en';
    import CoPayEs from './call-scripts/copay-es';
    import NoCoPayEs from './call-scripts/no-copay-es';

    //Vue.http.headers.common['X-CSRF-TOKEN'] = $('meta[name="csrf-token"]').attr('content');

    //for some reason i could not pass these as props from blade.php
    const hasTips = window.hasTips;
    const enrollee = window.enrollee;
    const userId = window.userId;
    const userFullName = window.userFullName;
    const providerFullName = window.providerFullName;
    const report = window.report;

    export default {
        name: 'enrollment-dashboard',
        props: [],
        components: {
            'copay-en': CoPayEn,
            'no-copay-en': NoCoPayEn,
            'copay-es': CoPayEs,
            'no-copay-es': NoCoPayEs,
        },
        computed: {
            enrolleeId: function () {
                return enrollee.id;
            },
            enrolleeUserId: function () {
                return enrollee.user ? enrollee.user.id : null;
            },
            enrollmentTips: function () {
                return enrollee.practice && enrollee.practice.enrollment_tips ? enrollee.practice.enrollment_tips.content : '';
            },
            last_call_outcome: function () {
                return enrollee.last_call_outcome ? enrollee.last_call_outcome : '';
            },
            last_call_outcome_reason: function () {
                return enrollee.last_call_outcome_reason ? enrollee.last_call_outcome_reason : '';
            },
            has_copay: function () {
                return enrollee.has_copay;
            },
            name: function () {
                return enrollee.first_name + ' ' + enrollee.last_name;
            },
            lang: function () {
                return enrollee.lang;
            },
            practice_id: function () {
                return enrollee.practice.id;
            },
            practice_name: function () {
                return enrollee.practice.display_name;
            },
            practice_phone: function () {
                return enrollee.practice.outgoing_phone_number;
            },
            total_time_in_system: function () {
                return this.report && this.report.total_time_in_system ? this.report.total_time_in_system : 0;
            },
            formatted_total_time_in_system: function () {
                return new Date(1000 * this.total_time_in_system_running).toISOString().substr(11, 8);
            },
            //other phone computer vars
            other_phone_label: function () {

                if (this.other_phone == '') {
                    return 'Other Phone Unknown...';
                }

                if (this.validatePhone(this.other_phone)) {
                    return 'Other Phone Valid!';
                }

                return 'Other Phone Invalid..'
            },
            other_is_valid: function () {
                return this.validatePhone(this.other_phone)
            },
            other_is_invalid: function () {
                return !this.validatePhone(this.other_phone)
            },
            //other phone computer vars
            home_phone_label: function () {

                if (this.home_phone == '') {
                    return 'Home Phone Unknown...';
                }

                if (this.validatePhone(this.home_phone)) {
                    return 'Home Phone Valid!';
                }

                return 'Home Phone Invalid..'
            },
            home_is_valid: function () {
                return this.validatePhone(this.home_phone)
            },
            home_is_invalid: function () {
                return !this.validatePhone(this.home_phone)
            },
            //other phone computer vars
            cell_phone_label: function () {

                if (this.cell_phone == '') {
                    return 'Cell Phone Unknown...';
                }

                if (this.validatePhone(this.cell_phone)) {
                    return 'Cell Phone Valid!';
                }

                return 'Cell Phone Invalid..'
            },
            cell_is_valid: function () {
                return this.validatePhone(this.cell_phone)
            },
            cell_is_invalid: function () {
                return !this.validatePhone(this.cell_phone)
            },
            utc_requested_callback(){
                return this.utc_reason === 'requested callback';
            },
        },
        data: function () {
            return {
                csrf: document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                userFullName: userFullName,
                providerFullName: providerFullName,
                hasTips: hasTips,
                report: report,

                home_phone: enrollee.home_phone,
                cell_phone: enrollee.cell_phone,
                other_phone: enrollee.other_phone,
                address: enrollee.address ? enrollee.address : 'N/A',
                address_2: enrollee.address_2 ? enrollee.address_2 : 'N/A',
                state: enrollee.state ? enrollee.state : 'N/A',
                city: enrollee.city ? enrollee.city : 'N/A',
                zip: enrollee.zip ? enrollee.zip : 'N/A',
                email: enrollee.email ? enrollee.email : 'N/A',
                dob: enrollee.dob ? enrollee.dob : 'N/A',

                disableHome: false,
                disableCell: false,
                disableOther: false,
                time_elapsed: 0,
                total_time_in_system_running: 0,
                onCall: false,
                callStatus: 'Summoning Calling Gods...',
                toCall: '',
                isSoftDecline: false,
                utc_reason: '',
                callError: null,
                consentedUrl: rootUrl('enrollment/consented'),
                utcUrl: rootUrl('enrollment/utc'),
                rejectedUrl: rootUrl('enrollment/rejected'),

                //twilio
                device: null
            };
        },
        mounted: function () {

            this.total_time_in_system_running = this.total_time_in_system;
            let self = this;
            self.initTwilio();

            //timer
            setInterval(function () {
                self.$data.total_time_in_system_running++;
                self.$data.time_elapsed++;
            }, 1000);

            $(document).ready(function () {

                M.Modal.init($('#consented'));
                M.Modal.init($('#utc'));
                M.Modal.init($('#tips'));

                M.Modal.init($('#rejected'), {
                    onCloseEnd: function () {
                        //always reset when modal is closed
                        self.isSoftDecline = false;
                    }
                });

                M.FormSelect.init($('select'));
                M.Dropdown.init($('.dropdown-trigger'), {
                    alignment: 'right',
                    coverTrigger: false
                });

                if (self.hasTips) {
                    let showTips = true;
                    const tipsSettings = self.getTipsSettings();
                    if (tipsSettings) {
                        if (tipsSettings[self.practice_id] && !tipsSettings[self.practice_id].show) {
                            showTips = false;
                        }
                    }

                    $('#do-not-show-tips-again').prop('checked', !showTips);
                    if (showTips) {
                        //show the modal here
                        $('#tips-link')[0].click();
                    }
                }

            });
        },
        methods: {

            //triggered when cilck on Soft Decline
            //gets reset when modal closes
            softReject() {
                this.isSoftDecline = true;
            },
            getTipsSettings() {
                const tipsSettingsStr = localStorage.getItem('enrollment-tips-per-practice');
                if (tipsSettingsStr) {
                    return JSON.parse(tipsSettingsStr);
                }
                return null;
            },
            setTipsSettings(settings) {
                localStorage.setItem('enrollment-tips-per-practice', JSON.stringify(settings));
            },
            /**
             * used by the tips modal
             * @param e
             */
            doNotShowTipsAgain(e) {
                let settings = this.getTipsSettings();
                if (!settings) {
                    settings = {};
                }
                settings[this.practice_id] = {show: !e.currentTarget.checked};
                this.setTipsSettings(settings);
            },
            validatePhone(value) {
                let isValid = this.isValidPhoneNumber(value)

                if (isValid) {
                    this.isValid = true;
                    this.disableHome = true;
                    return true;
                }
                else {
                    this.isValid = false;
                    this.disableHome = true;
                    return false;
                }
            },
            isValidPhoneNumber(string) {
                //return true if string is empty
                if (string.length === 0) {
                    return true
                }

                let matchNumbers = string.match(/\d+-?/g)

                if (matchNumbers === null) {
                    return false
                }

                matchNumbers = matchNumbers.join('')

                return !(matchNumbers === null || matchNumbers.length < 10 || string.match(/[a-z]/i));
            },
            call(phone, type) {

                //make sure we have +1 on the phone,
                //and remove any dashes
                let phoneSanitized = phone.toString();
                phoneSanitized = phoneSanitized.replace(/-/g, "");
                if (!phoneSanitized.startsWith("+1")) {
                    phoneSanitized = "+1" + phoneSanitized;
                }

                this.callError = null;
                this.onCall = true;
                this.callStatus = "Calling " + type + "..." + phoneSanitized;
                M.toast({html: this.callStatus, displayLength: 3000});
                this.device.connect({
                    To: phoneSanitized,
                    From: this.practice_phone ? this.practice_phone : undefined,
                    IsUnlistedNumber: false,
                    InboundUserId: this.enrolleeUserId,
                    OutboundUserId: userId
                });
            },
            hangUp() {
                this.onCall = false;
                this.callStatus = "Ended Call";
                M.toast({html: this.callStatus, displayLength: 3000});
                this.device.disconnectAll();
            },
            initTwilio: function () {
                const self = this;
                const url = rootUrl(`/twilio/token`);

                self.$http.get(url)
                    .then(response => {
                        self.log = 'Initializing';
                        self.device = new Twilio.Device(response.data.token, {
                            closeProtection: true
                        });

                        self.device.on('disconnect', () => {
                            console.log('twilio device: disconnect');
                            self.log = 'Call ended.';
                            self.onCall = false;
                        });

                        self.device.on('offline', () => {
                            console.log('twilio device: offline');
                            self.log = 'Offline.';
                        });

                        self.device.on('error', (err) => {
                            console.error('twilio device: error', err);
                            self.callError = err.message;
                        });

                        self.device.on('ready', () => {
                            console.log('twilio device: ready');
                            self.log = 'Ready to make call';
                            M.toast({html: self.log, displayLength: 5000});
                        });
                    })
                    .catch(error => {
                        console.log(error);
                        self.log = 'Could not fetch token, see console.log';
                    });
            }
        }
    }

</script>
<style>

    .consented_modal {
        max-height: 100% !important;
        height: 90% !important;
        width: 80% !important;
        top: 4% !important;
    }

    .sidebar-demo-list {
        height: 24px;
        width: 278px;
        font-size: 16px;
        padding-left: 15px;
        line-height: 20px !important;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .valid {
        color: green;
    }

    .invalid {
        color: red;
    }

    .enrollment-script {
        font-size: 20px;
    }

    /**
        NOTE: these styles are for sidebar.blade
        For some reason, there were not applied if added in that file
     */

    .counter {
        font-size: larger;
    }

    .card-subtitle {
    }

    .side-nav.fixed {
        width: 25%;
        margin-top: 65px;
        position: fixed;
    }

    .side-nav a {
        height: 36px;
        line-height: 36px;
    }

    .side-nav .row {
        margin-bottom: 0;
    }

    .side-nav .card {
        margin: .5rem 0 0.1rem 0;
    }

    .side-nav .card-content {
        padding: 10px;
    }

    .call-button {
        max-width: 100%;
        background: #4caf50;
    }

    .action-buttons {
        text-align: center;
    }

    .action-buttons li {
        margin-bottom: 4px;
    }

    .action-buttons li a {
        width: 100%;
    }

</style>