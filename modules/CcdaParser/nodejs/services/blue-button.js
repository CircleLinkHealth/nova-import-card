/* BlueButton.js -- 0.4.3 */

!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define([],b):a.BlueButton=b()}(this,function(){var a=function(){var b=function(b){if(b=c(b),"<"===b.charAt(0))try{return a.XML.parse(b)}catch(a){console.log&&console.log("File looked like it might be XML but couldn't be parsed.")}try{return JSON.parse(b)}catch(a){throw console.error&&console.error("Error: Cannot parse this file. BB.js only accepts valid XML (for parsing) or JSON (for generation). If you are attempting to provide XML or JSON, please run your data through a validator to see if it is malformed.\n"),a}},c=function(a){return a?a.replace(/^\s+|\s+$/g,""):a},d=function(){var a=function(a){return a<10?"0"+a:a},b=function(b,c){var d=this[b];return c&&d instanceof Date&&!isNaN(d.getTime())?d._parsedWithTimeData||d.getHours()||d.getMinutes()||d.getSeconds()||d.getMilliseconds()?d.getUTCFullYear()+"-"+a(d.getUTCMonth()+1)+"-"+a(d.getUTCDate())+"T"+a(d.getUTCHours())+":"+a(d.getUTCMinutes())+":"+a(d.getUTCSeconds())+"Z":a(d.getMonth()+1)+"/"+a(d.getDate())+"/"+d.getFullYear():c};return JSON.stringify(this,b,2)},e=function(a){var b;for(var c in a)a.hasOwnProperty(c)&&(b=a[c],null===b&&delete a[c],b instanceof Object&&(b=e(b)));return a};return{parseData:b,stripWhitespace:c,json:d,trim:e}}();a.Codes=function(){var a={F:"female",M:"male",UN:"undifferentiated"},b={N:"annulled",C:"common law",D:"divorced",P:"domestic partner",I:"interlocutory",E:"legally separated",G:"living together",M:"married",O:"other",R:"registered domestic partner",A:"separated",S:"single",U:"unknown",B:"unmarried",T:"unreported",W:"widowed"},c={H:"home",HP:"home",MC:"mobile",WP:"work"},d={1001:"adventist",1002:"african religions",1003:"afro-caribbean religions",1004:"agnosticism",1005:"anglican",1006:"animism",1061:"assembly of god",1007:"atheism",1008:"babi & baha'i faiths",1009:"baptist",1010:"bon",1062:"brethren",1011:"cao dai",1012:"celticism",1013:"christian (non-catholic, non-specific)",1063:"christian scientist",1064:"church of christ",1065:"church of god",1014:"confucianism",1066:"congregational",1015:"cyberculture religions",1067:"disciples of christ",1016:"divination",1068:"eastern orthodox",1069:"episcopalian",1070:"evangelical covenant",1017:"fourth way",1018:"free daism",1071:"friends",1072:"full gospel",1019:"gnosis",1020:"hinduism",1021:"humanism",1022:"independent",1023:"islam",1024:"jainism",1025:"jehovah's witnesses",1026:"judaism",1027:"latter day saints",1028:"lutheran",1029:"mahayana",1030:"meditation",1031:"messianic judaism",1073:"methodist",1032:"mitraism",1074:"native american",1075:"nazarene",1033:"new age",1034:"non-roman catholic",1035:"occult",1036:"orthodox",1037:"paganism",1038:"pentecostal",1076:"presbyterian",1039:"process, the",1077:"protestant",1078:"protestant, no denomination",1079:"reformed",1040:"reformed/presbyterian",1041:"roman catholic church",1080:"salvation army",1042:"satanism",1043:"scientology",1044:"shamanism",1045:"shiite (islam)",1046:"shinto",1047:"sikism",1048:"spiritualism",1049:"sunni (islam)",1050:"taoism",1051:"theravada",1081:"unitarian universalist",1052:"unitarian-universalism",1082:"united church of christ",1053:"universal life church",1054:"vajrayana (tibetan)",1055:"veda",1056:"voodoo",1057:"wicca",1058:"yaohushua",1059:"zen buddhism",1060:"zoroastrianism"},e={"2028-9":"asian","2054-5":"black or african american","2135-2":"hispanic or latino","2076-8":"native","2186-5":"not hispanic or latino","2131-1":"other","2106-3":"white"},f={ACC:"accident site",ACHFID:"accreditation location identifier",ACTMIL:"active duty military",AGNT:"agent",ALL:"allergy clinic",AMB:"ambulance",AMPUT:"amputee clinic",ANTIBIOT:"antibiotic",ASSIST:"assistive non-person living subject",AUNT:"aunt",B:"blind",BF:"beef",BILL:"billing contact",BIOTH:"biotherapeutic non-person living subject",BL:"broiler",BMTC:"bone marrow transplant clinic",BMTU:"bone marrow transplant unit",BR:"breeder",BREAST:"breast clinic",BRO:"brother",BROINLAW:"brother-in-law",C:"calibrator",CANC:"child and adolescent neurology clinic",CAPC:"child and adolescent psychiatry clinic",CARD:"ambulatory health care facilities; clinic/center; rehabilitation: cardiac facilities",CAREGIVER:"care giver",CAS:"asylum seeker",CASM:"single minor asylum seeker",CATH:"cardiac catheterization lab",CCO:"clinical companion",CCU:"coronary care unit",CHEST:"chest unit",CHILD:"child",CHLDADOPT:"adopted child",CHLDFOST:"foster child",CHLDINLAW:"child in-law",CHR:"chronic care facility",CLAIM:"claimant",CN:"national",CNRP:"non-country member without residence permit",CNRPM:"non-country member minor without residence permit",CO:"companion",COAG:"coagulation clinic",COCBEN:"continuity of coverage beneficiary",COMM:"community location",COMMUNITYLABORATORY:"community laboratory",COUSN:"cousin",CPCA:"permit card applicant",CRIMEVIC:"crime victim",CRP:"non-country member with residence permit",CRPM:"non-country member minor with residence permit",CRS:"colon and rectal surgery clinic",CSC:"community service center",CVDX:"cardiovascular diagnostics or therapeutics unit",DA:"dairy",DADDR:"delivery address",DAU:"natural daughter",DAUADOPT:"adopted daughter",DAUC:"daughter",DAUFOST:"foster daughter",DAUINLAW:"daughter in-law",DC:"therapeutic class",DEBR:"debridement",DERM:"dermatology clinic",DIFFABL:"differently abled",DOMPART:"domestic partner",DPOWATT:"durable power of attorney",DR:"draft",DU:"dual",DX:"diagnostics or therapeutics unit",E:"electronic qc",ECHO:"echocardiography lab",ECON:"emergency contact",ENDO:"endocrinology clinic",ENDOS:"endoscopy lab",ENROLBKR:"enrollment broker",ENT:"otorhinolaryngology clinic",EPIL:"epilepsy unit",ER:"emergency room",ERL:"enrollment",ETU:"emergency trauma unit",EXCEST:"executor of estate",EXT:"extended family member",F:"filler proficiency",FAMDEP:"family dependent",FAMMEMB:"family member",FI:"fiber",FMC:"family medicine clinic",FRND:"unrelated friend",FSTUD:"full-time student",FTH:"father",FTHINLAW:"father-in-law",FULLINS:"fully insured coverage sponsor",G:"group",GACH:"hospitals; general acute care hospital",GD:"generic drug",GDF:"generic drug form",GDS:"generic drug strength",GDSF:"generic drug strength form",GGRFTH:"great grandfather",GGRMTH:"great grandmother",GGRPRN:"great grandparent",GI:"gastroenterology clinic",GIDX:"gastroenterology diagnostics or therapeutics lab",GIM:"general internal medicine clinic",GRFTH:"grandfather",GRMTH:"grandmother",GRNDCHILD:"grandchild",GRNDDAU:"granddaughter",GRNDSON:"grandson",GRPRN:"grandparent",GT:"guarantor",GUADLTM:"guardian ad lidem",GUARD:"guardian",GYN:"gynecology clinic",HAND:"hand clinic",HANDIC:"handicapped dependent",HBRO:"half-brother",HD:"hemodialysis unit",HEM:"hematology clinic",HLAB:"hospital laboratory",HOMEHEALTH:"home health",HOSP:"hospital",HPOWATT:"healthcare power of attorney",HRAD:"radiology unit",HSIB:"half-sibling",HSIS:"half-sister",HTN:"hypertension clinic",HU:"hospital unit",HUSB:"husband",HUSCS:"specimen collection site",ICU:"intensive care unit",IEC:"impairment evaluation center",INDIG:"member of an indigenous people",INFD:"infectious disease clinic",INJ:"injured plaintiff",INJWKR:"injured worker",INLAB:"inpatient laboratory",INPHARM:"inpatient pharmacy",INV:"infertility clinic",JURID:"jurisdiction location identifier",L:"pool",LABORATORY:"laboratory",LOCHFID:"local location identifier",LY:"layer",LYMPH:"lympedema clinic",MAUNT:"maternalaunt",MBL:"medical laboratory",MCOUSN:"maternalcousin",MGDSF:"manufactured drug strength form",MGEN:"medical genetics clinic",MGGRFTH:"maternalgreatgrandfather",MGGRMTH:"maternalgreatgrandmother",MGGRPRN:"maternalgreatgrandparent",MGRFTH:"maternalgrandfather",MGRMTH:"maternalgrandmother",MGRPRN:"maternalgrandparent",MHSP:"military hospital",MIL:"military",MOBL:"mobile unit",MT:"meat",MTH:"mother",MTHINLAW:"mother-in-law",MU:"multiplier",MUNCLE:"maternaluncle",NBOR:"neighbor",NBRO:"natural brother",NCCF:"nursing or custodial care facility",NCCS:"neurology critical care and stroke unit",NCHILD:"natural child",NEPH:"nephrology clinic",NEPHEW:"nephew",NEUR:"neurology clinic",NFTH:"natural father",NFTHF:"natural father of fetus",NIECE:"niece",NIENEPH:"niece/nephew",NMTH:"natural mother",NOK:"next of kin",NPRN:"natural parent",NS:"neurosurgery unit",NSIB:"natural sibling",NSIS:"natural sister",O:"operator proficiency",OB:"obstetrics clinic",OF:"outpatient facility",OMS:"oral and maxillofacial surgery clinic",ONCL:"medical oncology clinic",OPH:"opthalmology clinic",OPTC:"optometry clinic",ORG:"organizational contact",ORTHO:"orthopedics clinic",OUTLAB:"outpatient laboratory",OUTPHARM:"outpatient pharmacy",P:"patient",PAINCL:"pain clinic",PATHOLOGIST:"pathologist",PAUNT:"paternalaunt",PAYOR:"payor contact",PC:"primary care clinic",PCOUSN:"paternalcousin",PEDC:"pediatrics clinic",PEDCARD:"pediatric cardiology clinic",PEDE:"pediatric endocrinology clinic",PEDGI:"pediatric gastroenterology clinic",PEDHEM:"pediatric hematology clinic",PEDHO:"pediatric oncology clinic",PEDICU:"pediatric intensive care unit",PEDID:"pediatric infectious disease clinic",PEDNEPH:"pediatric nephrology clinic",PEDNICU:"pediatric neonatal intensive care unit",PEDRHEUM:"pediatric rheumatology clinic",PEDU:"pediatric unit",PGGRFTH:"paternalgreatgrandfather",PGGRMTH:"paternalgreatgrandmother",PGGRPRN:"paternalgreatgrandparent",PGRFTH:"paternalgrandfather",PGRMTH:"paternalgrandmother",PGRPRN:"paternalgrandparent",PH:"policy holder",PHARM:"pharmacy",PHLEBOTOMIST:"phlebotomist",PHU:"psychiatric hospital unit",PL:"pleasure",PLS:"plastic surgery clinic",POD:"podiatry clinic",POWATT:"power of attorney",PRC:"pain rehabilitation center",PREV:"preventive medicine clinic",PRN:"parent",PRNINLAW:"parent in-law",PROCTO:"proctology clinic",PROFF:"provider's office",PROG:"program eligible",PROS:"prosthodontics clinic",PRS:"personal relationship",PSI:"psychology clinic",PSTUD:"part-time student",PSY:"psychiatry clinic",PSYCHF:"psychiatric care facility",PT:"patient",PTRES:"patient's residence",PUNCLE:"paternaluncle",Q:"quality control",R:"replicate",RADDX:"radiology diagnostics or therapeutics unit",RADO:"radiation oncology unit",RC:"racing",RESPRSN:"responsible party",RETIREE:"retiree",RETMIL:"retired military",RH:"rehabilitation hospital",RHAT:"addiction treatment center",RHEUM:"rheumatology clinic",RHII:"intellectual impairment center",RHMAD:"parents with adjustment difficulties center",RHPI:"physical impairment center",RHPIH:"physical impairment - hearing center",RHPIMS:"physical impairment - motor skills center",RHPIVS:"physical impairment - visual skills center",RHU:"rehabilitation hospital unit",RHYAD:"youths with adjustment difficulties center",RNEU:"neuroradiology unit",ROOM:"roommate",RTF:"residential treatment facility",SCHOOL:"school",SCN:"screening",SEE:"seeing",SELF:"self",SELFINS:"self insured coverage sponsor",SH:"show",SIB:"sibling",SIBINLAW:"sibling in-law",SIGOTHR:"significant other",SIS:"sister",SISINLAW:"sister-in-law",SLEEP:"sleep disorders unit",SNF:"skilled nursing facility",SNIFF:"sniffing",SON:"natural son",SONADOPT:"adopted son",SONC:"son",SONFOST:"foster son",SONINLAW:"son in-law",SPMED:"sports medicine clinic",SPON:"sponsored dependent",SPOWATT:"special power of attorney",SPS:"spouse",STPBRO:"stepbrother",STPCHLD:"step child",STPDAU:"stepdaughter",STPFTH:"stepfather",STPMTH:"stepmother",STPPRN:"step parent",STPSIB:"step sibling",STPSIS:"stepsister",STPSON:"stepson",STUD:"student",SU:"surgery clinic",SUBJECT:"self",SURF:"substance use rehabilitation facility",THIRDPARTY:"third party",TPA:"third party administrator",TR:"transplant clinic",TRAVEL:"travel and geographic medicine clinic",TRB:"tribal member",UMO:"utilization management organization",UNCLE:"uncle",UPC:"underage protection center",URO:"urology clinic",V:"verifying",VET:"veteran",VL:"veal",WARD:"ward",WIFE:"wife",WL:"wool",WND:"wound clinic",WO:"working",WORK:"work site"},g={55561003:"active",73425007:"inactive",90734009:"chronic",7087005:"intermittent",255227004:"recurrent",413322009:"resolved",415684004:"rule out",410516002:"ruled out"},h=function(a){for(var b={},c=Object.keys(a),d=0,e=c.length;d<e;d++)b[a[c[d]]]=c[d];return b},i=function(a){return function(b){return a[b]||null}},j=function(a){return function(b){if(!b)return null;var c=h(a);return b=b.toLowerCase(),c[b]||null}};return{gender:i(a),reverseGender:j(a),maritalStatus:i(b),phone:i(c),reverseMaritalStatus:j(b),religion:i(d),reverseReligion:j(d),raceEthnicity:i(e),reverseRaceEthnicity:j(e),role:i(f),reverseRole:j(f),problemStatus:i(g),reverseProblemStatus:j(g)}}(),a.XML=function(){var b,c=function(a){function b(a){return{el:a,template:e,content:f,tag:g,immediateChildTag:h,immediateChildrenTags:i,elsByTag:j,attr:l,boolAttr:m,val:n,isEmpty:p}}if(a.length){for(var c=[],d=0;d<a.length;d++)c.push(b(a[d]));return c}return b(a)},d=function(a,b,c,d){a=a.getElementsByTagName(b);for(var e=0;e<a.length;e++)if(a[e].getAttribute(c)===d)return a[e]},e=function(a){var b=d(this.el,"templateId","root",a);return b?c(b.parentNode):o()},f=function(a){var b=d(this.el,"content","ID",a);return b||(b=d(this.el,"td","ID",a)),b||(b=d(this.el,"caption","ID",a)||d(this.el,"paragraph","ID",a)||d(this.el,"tr","ID",a)||d(this.el,"item","ID",a)),b?c(b):o()},g=function(a){var b=this.el.getElementsByTagName(a)[0];return b?c(b):o()},h=function(a){var b=this.el.getElementsByTagName(a);if(!b)return null;for(var d=0;d<b.length;d++)if(b[d].parentNode===this.el)return c(b[d]);return o()},i=function(a){var b=this.el.getElementsByTagName(a);if(!b)return null;for(var d=[],e=0;e<b.length;e++)b[e].parentNode===this.el&&d.push(c(b[e]));return d},j=function(a){return c(this.el.getElementsByTagName(a))},k=function(a){return a?a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'"):a},l=function(a){if(!this.el)return null;var b=this.el.getAttribute(a);return b?k(b):null},m=function(a){var b=this.attr(a);return"true"===b||"1"===b},n=function(){if(!this.el)return null;if(!this.el.childNodes||!this.el.childNodes.length)return null;var b=this.el.textContent;if(!a.stripWhitespace(b)){var d;if(1===this.el.childNodes.length&&"reference"===this.el.childNodes[0].tagName)d=this.el.childNodes[0].getAttribute("value");else{if(3!==this.el.childNodes.length||"reference"!==this.el.childNodes[1].tagName)return k(b);d=this.el.childNodes[1].getAttribute("value")}if(d&&"#"===d[0]){d=d.slice(1);return c(this.el.ownerDocument).content(d).val()}}return k(b.trim())},o=function(){var a=t.createElement("empty");return c(a)},p=function(){return"empty"===this.el.tagName.toLowerCase()},q=function(a){if(!a||"string"!=typeof a)return console.log("BB Error: XML data is not a string"),null;var d,e;if(s)e=new b.DOMParser,d=e.parseFromString(a,"text/xml");else if(window.DOMParser)e=new DOMParser,d=e.parseFromString(a,"text/xml"),d.getElementsByTagName("parsererror").length&&(a=a.replace(/&/g,"&amp;"),d=e.parseFromString(a,"text/xml"));else try{d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a)}catch(a){console.log("BB ActiveX Exception: Could not parse XML")}return d&&d.documentElement&&!d.getElementsByTagName("parsererror").length?c(d):(console.log("BB Error: Could not parse XML"),null)},r=this,s=!1,t=r.document;return"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(s=!0,b=require("xmldom"),t=(new b.DOMImplementation).createDocument()),{parse:q}}();var b=function(){function b(a){a=a||"";var b=a.match(h)||[],d=b[b.length-1]||[],e=(d+"").match(g)||["-",0,0],f=60*e[1]+c(e[2]);return"+"===e[0]?f:-f}function c(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}var d=function(a){return a.template?a.template("2.16.840.1.113883.3.88.11.32.1").isEmpty()?a.template("2.16.840.1.113883.10.20.22.1.1").isEmpty()?void 0:"ccda":"c32":"json"},e=function(){var a=function(a){for(var b=0;b<this.length;b++)a(this[b])},b=this.elsByTag("entry");return b.each=a,b},f=function(a){if(!a||"string"!=typeof a)return null;if(4===a.length)return new Date(a,0,1);var d=a.substr(0,4),e=parseInt(a.substr(4,2),10)-1,f=a.substr(6,2)||1;if(a.length>=12){var g=a.substr(8,2),h=a.substr(10,2),i=a.substr(12,2);if(a.length>14){var j=b(a.substr(14));h=c(h)-j}var k=new Date(Date.UTC(d,e,f,g,h,i));return k._parsedWithTimeData=!0,k}return new Date(d,e,f)},g=/([\+\-]|\d\d)/gi,h=/Z|[\+\-]\d\d:?\d\d/gi,i=function(a){for(var b=a.tag("prefix").val(),c=a.elsByTag("given"),d=[],e=0;e<c.length;e++){var f=c[e].val();f&&d.push(f)}return{prefix:b,given:d,family:a.tag("family").val(),suffix:a.tag("suffix").val()}},j=function(a){for(var b=a.elsByTag("streetAddressLine"),c=[],d=0;d<b.length;d++){var e=b[d].val();e&&c.push(e)}return{street:c,city:a.tag("city").val(),state:a.tag("state").val(),zip:a.tag("postalCode").val(),country:a.tag("country").val()}},k=function(a){return a.map(function(a){return{extension:a.attr("extension"),root:a.attr("root"),assigningAuthorityName:a.attr("assigningAuthorityName")}})},l=function(b){return b instanceof Array?b.map(function(b){return{type:a.Codes.phone(b.attr("use")),number:b.attr("value")}}):{type:"",number:""}};return"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(module.exports={parseDate:f}),{detect:d,entries:e,parseDate:f,parseName:i,parseAddress:j,parseIds:k,parsePhones:l}}();b.C32=function(){var a=function(a){return a.section=c,a},c=function(a){var c,d=b.entries;switch(a){case"document":return this.template("2.16.840.1.113883.3.88.11.32.1");case"allergies":return c=this.template("2.16.840.1.113883.3.88.11.83.102"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.2")),c.entries=d,c;case"demographics":return this.template("2.16.840.1.113883.3.88.11.32.1");case"encounters":return c=this.template("2.16.840.1.113883.3.88.11.83.127"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.3")),c.entries=d,c;case"immunizations":return c=this.template("2.16.840.1.113883.3.88.11.83.117"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.6")),c.entries=d,c;case"results":return c=this.template("2.16.840.1.113883.3.88.11.83.122"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.14")),c.entries=d,c;case"medications":return c=this.template("2.16.840.1.113883.3.88.11.83.112"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.8")),c.entries=d,c;case"payers":return c=this.template("2.16.840.1.113883.10.20.1.9"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.18")),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.20")),c.entries=d,c;case"problems":return c=this.template("2.16.840.1.113883.3.88.11.83.103"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.11")),c.entries=d,c;case"procedures":return c=this.template("2.16.840.1.113883.3.88.11.83.108"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.12")),c.entries=d,c;case"vitals":return c=this.template("2.16.840.1.113883.3.88.11.83.119"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.16")),c.entries=d,c}return null};return{process:a,section:c}}(),b.CCDA=function(){var a=function(a){return a.section=c,a},c=function(a){var c,d=b.entries;switch(a){case"document":return this.template("2.16.840.1.113883.10.20.22.1.1");case"allergies":return c=this.template("2.16.840.1.113883.10.20.22.2.6.1"),c.entries=d,c;case"care_plan":return c=this.template("2.16.840.1.113883.10.20.22.2.10"),c.entries=d,c;case"chief_complaint":return c=this.template("2.16.840.1.113883.10.20.22.2.13"),c.isEmpty()&&(c=this.template("1.3.6.1.4.1.19376.1.5.3.1.1.13.2.1")),c;case"demographics":return this.template("2.16.840.1.113883.10.20.22.1.1");case"encounters":return c=this.template("2.16.840.1.113883.10.20.22.2.22"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.22.1")),c.entries=d,c;case"functional_statuses":return c=this.template("2.16.840.1.113883.10.20.22.2.14"),c.entries=d,c;case"immunizations":return c=this.template("2.16.840.1.113883.10.20.22.2.2.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.2")),c.entries=d,c;case"instructions":return c=this.template("2.16.840.1.113883.10.20.22.2.45"),c.entries=d,c;case"results":return c=this.template("2.16.840.1.113883.10.20.22.2.3.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.3")),c.entries=d,c;case"medications":return c=this.template("2.16.840.1.113883.10.20.22.2.1.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.1")),c.entries=d,c;case"payers":return c=this.template("2.16.840.1.113883.10.20.22.2.18"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.9")),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.1.20")),c.entries=d,c;case"problems":return c=this.template("2.16.840.1.113883.10.20.22.2.5.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.5")),c.entries=d,c;case"procedures":return c=this.template("2.16.840.1.113883.10.20.22.2.7.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.7")),c.entries=d,c;case"social_history":return c=this.template("2.16.840.1.113883.10.20.22.2.17"),c.entries=d,c;case"vitals":return c=this.template("2.16.840.1.113883.10.20.22.2.4.1"),c.isEmpty()&&(c=this.template("2.16.840.1.113883.10.20.22.2.4")),c.entries=d,c}return null};return{process:a,section:c}}();var c=function(){var a=function(){};if("undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(ejs=require("ejs")),"undefined"!=typeof ejs){var b=function(a){return a<10?"0"+a:String(a)};ejs.filters.hl7Date=function(a){try{if(null===a||void 0===a)return'nullFlavor="UNK"';var c=new Date(a);if(isNaN(c.getTime()))return a;var d=null;if(c.getHours()||c.getMinutes()||c.getSeconds()){d=c.getUTCFullYear()+b(c.getUTCMonth()+1)+b(c.getUTCDate());return'value="'+d+(b(c.getUTCHours())+b(c.getUTCMinutes())+b(c.getUTCSeconds())+"+0000")+'"'}return'value="'+(d=String(c.getFullYear())+b(c.getMonth()+1)+b(c.getDate()))+'"'}catch(b){return a}};var c=function(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")};ejs.filters.hl7Code=function(a){if(!a)return"";var b="",d=a.name||"";return a.name&&(b+='displayName="'+c(d)+'"'),a.code?(b+=' code="'+a.code+'"',a.code_system&&(b+=' codeSystem="'+c(a.code_system)+'"'),a.code_system_name&&(b+=' codeSystemName="'+c(a.code_system_name)+'"')):b+=' nullFlavor="UNK"',a.name||a.code?b:'nullFlavor="UNK"'},ejs.filters.emptyStringIfFalsy=function(a){return a||""},ejs.helpers||(ejs.helpers={}),ejs.helpers.simpleTag=function(a,b){return b?"<"+a+">"+b+"</"+a+">":"<"+a+' nullFlavor="UNK" />'},ejs.helpers.addressTags=function(a){if(!a)return'<streetAddressLine nullFlavor="NI" />\n<city nullFlavor="NI" />\n<state nullFlavor="NI" />\n<postalCode nullFlavor="NI" />\n<country nullFlavor="NI" />\n';var b="";if(a.street.length)for(var c=0;c<a.street.length;c++)b+=ejs.helpers.simpleTag("streetAddressLine",a.street[c])+"\n";else b+=ejs.helpers.simpleTag("streetAddressLine",null)+"\n";return b+=ejs.helpers.simpleTag("city",a.city)+"\n",b+=ejs.helpers.simpleTag("state",a.state)+"\n",b+=ejs.helpers.simpleTag("postalCode",a.zip)+"\n",b+=ejs.helpers.simpleTag("country",a.country)+"\n"},ejs.helpers.nameTags=function(a){if(!a)return'<given nullFlavor="NI" />\n<family nullFlavor="NI" />\n';var b="";if(a.prefix&&(b+=ejs.helpers.simpleTag("prefix",a.prefix)+"\n"),a.given.length)for(var c=0;c<a.given.length;c++)b+=ejs.helpers.simpleTag("given",a.given[c])+"\n";else b+=ejs.helpers.simpleTag("given",null)+"\n";return b+=ejs.helpers.simpleTag("family",a.family)+"\n",a.suffix&&(b+=ejs.helpers.simpleTag("suffix",a.suffix)+"\n"),b}}return{method:a}}();c.C32=function(){return{run:function(a,b,c){return console.log("C32 generation is not implemented yet"),null}}}(),c.CCDA=function(){return{run:function(b,c,d){if(!ejs)return console.log("The BB.js Generator (JSON->XML) requires the EJS template package. Install it in Node or include it before this package in the browser."),null;if(!c)return console.log("Please provide a template EJS file for the Generator to use. Load it via fs.readFileSync in Node or XHR in the browser."),null;var e=d?new Date("2000-01-01T12:00:00Z"):new Date;return ejs.render(c,{filename:"ccda.xml",bb:b,now:e,tagHelpers:ejs.helpers,codes:a.Codes})}}}();var d=function(){return{method:function(){}}}();d.C32=function(){return{run:function(b){var c={};return c.document=d.C32.document(b),c.allergies=d.C32.allergies(b),c.demographics=d.C32.demographics(b),c.encounters=d.C32.encounters(b),c.immunizations=d.C32.immunizations(b).administered,c.immunization_declines=d.C32.immunizations(b).declined,c.results=d.C32.results(b),c.medications=d.C32.medications(b),c.payers=d.C32.payers(b),c.problems=d.C32.problems(b),c.procedures=d.C32.procedures(b),c.vitals=d.C32.vitals(b),c.json=a.json,c.document.json=a.json,c.allergies.json=a.json,c.demographics.json=a.json,c.encounters.json=a.json,c.immunizations.json=a.json,c.immunization_declines.json=a.json,c.results.json=a.json,c.medications.json=a.json,c.payers.json=a.json,c.problems.json=a.json,c.procedures.json=a.json,c.vitals.json=a.json,c.smoking_status={date:null,name:null,code:null,code_system:null,code_system_name:null},c.smoking_status.json=a.json,c.chief_complaint={text:null},c.chief_complaint.json=a.json,c.care_plan=[],c.care_plan.json=a.json,c.instructions=[],c.instructions.json=a.json,c.functional_statuses=[],c.functional_statuses.json=a.json,c}}}(),d.C32.document=function(c){var d,e=b.parseDate,f=b.parseName,g=b.parseAddress,h=b.parseIds,i=b.parsePhones,j=c.section("document"),k=e(j.tag("effectiveTime").attr("value")),l=a.stripWhitespace(j.tag("title").val()),m=j.tag("author");d=m.tag("assignedPerson").tag("name");var n=f(d),o=null;n.prefix||n.given.length||n.family||(n.family=d.val()),d=m.tag("addr");var p=g(d);d=m.tag("assignedAuthor").immediateChildrenTags("telecom");for(var q=i(d),r=[],s=j.tag("documentationOf").elsByTag("performer"),t=0;t<s.length;t++){d=s[t].tag("assignedPerson").tag("name");var u=f(d),v=i(s[t].tag("assignedEntity").immediateChildrenTags("telecom")),w=g(d.tag("addr")),x=s[t].tag("assignedEntity").tag("id").attr("extension"),y="ProviderID"==s[t].tag("assignedEntity").tag("id").attr("extension")?s[t].tag("assignedEntity").tag("id").attr("root"):null;r.push({provider_id:y,npi:x,name:u,phones:v,address:w})}d=j.tag("legalAuthenticator");var z=e(d.tag("time").attr("value")),A=f(d.tag("assignedPerson").tag("name")),B=g(d.tag("representedOrganization").tag("addr")),C=d.tag("assignedEntity").immediateChildrenTags("id"),D=h(C),E=d.tag("representedOrganization").immediateChildrenTags("id"),F=h(E),G=d.tag("representedOrganization").tag("name").val(),H=d.tag("representedOrganization").immediateChildrenTags("telecom"),I=i(H);d=j.tag("encompassingEncounter");var J=a.stripWhitespace(d.tag("name").val()),K=g(d.tag("addr")),L=null;return d=d.tag("effectiveTime"),d.isEmpty()||(L=e(d.attr("value"))),{custodian:{name:j.tag("custodian").tag("assignedCustodian").tag("representedCustodianOrganization").tag("name").val()},date:k,title:l,author:{npi:o,name:n,address:p,phones:q},documentation_of:r,legal_authenticator:{date:z,ids:D,assigned_person:A,representedOrganization:{ids:F,name:G,phones:I,address:B}},location:{name:J,address:K,encounter_date:L}}},d.C32.allergies=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,[]);return c.section("allergies").entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.tag("low").attr("value")),g=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.3.88.11.83.6").tag("code");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.3.88.11.83.6").tag("value");var l=d.attr("displayName"),m=d.attr("code"),n=d.attr("codeSystem"),o=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.1.54").tag("value");var p=d.attr("displayName"),q=d.attr("code"),r=d.attr("codeSystem");p||(d=b.template("2.16.840.1.113883.10.20.1.54").tag("text"),d.isEmpty()||(p=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.1.55").tag("value");var s=d.attr("displayName");d=b.tag("participant").tag("code");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");t||(d=b.tag("participant").tag("name"),d.isEmpty()||(t=d.val())),t||(d=b.template("2.16.840.1.113883.3.88.11.83.6").tag("originalText"),d.isEmpty()||(t=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.1.39").tag("value");var x=d.attr("displayName");f.push({date_range:{start:c,end:g},name:h,code:i,code_system:j,code_system_name:k,status:x,severity:s,reaction:{name:p,code:q,code_system:r},reaction_type:{name:l,code:m,code_system:n,code_system_name:o},allergen:{name:t,code:u,code_system:v,code_system_name:w}})}),f},d.C32.demographics=function(c){var d,e=b.parseDate,f=b.parseName,g=b.parseAddress,h=b.parsePhones,i=b.parseIds,j=c.section("demographics"),k=j.tag("patientRole");d=k.tag("patient").tag("name");for(var l=f(d),m=k.elsByTag("id"),n=k.tag("id").attr("extension"),o=[],p=0;p<m.length;p++)null!==m[p].attr("assigningAuthorityName")&&("mrn"==m[p].attr("assigningAuthorityName").toLowerCase()&&(n=m[p].attr("extension")),o.push({name:m[p].attr("assigningAuthorityName").toLowerCase(),id:m[p].attr("extension")}));d=k.tag("patient");var q=e(d.tag("birthTime").attr("value")),r=a.Codes.gender(d.tag("administrativeGenderCode").attr("code")),s=a.Codes.maritalStatus(d.tag("maritalStatusCode").attr("code"));d=k.tag("addr");var t=g(d);d=k.immediateChildrenTags("telecom");var u=h(d),v=null,w=k.tag("languageCommunication").tag("languageCode").attr("code"),x=k.tag("raceCode").attr("displayName"),y=k.tag("ethnicGroupCode").attr("displayName"),z=k.tag("religiousAffiliationCode").attr("displayName");d=k.tag("birthplace");var A=g(d);d=k.tag("guardian");var B=d.tag("code").attr("displayName"),C=d.tag("code").attr("code"),D=d.tag("telecom").attr("value");d=d.tag("guardianPerson").tag("name");var E=f(d);d=k.tag("guardian").tag("addr");var F=g(d);d=k.tag("providerOrganization");var G=d.tag("name").val(),H=h(d.immediateChildrenTags("telecom")),I=g(d.tag("addr")),J=i(d.immediateChildrenTags("id"));d=j.immediateChildrenTags("participant");var K=d.map(function(b){return b=b.tag("associatedEntity"),{relationship:a.Codes.role(b.attr("classCode")),relationship_code:{code:b.tag("code").attr("code"),displayName:b.tag("code").attr("displayName")},phones:h(b.immediateChildrenTags("telecom")),name:f(b.tag("associatedPerson").tag("name"))}});return{ids:o,name:l,dob:q,gender:r,mrn_number:n,marital_status:s,address:t,phones:u,email:v,language:w,race:x,ethnicity:y,religion:z,birthplace:{state:A.state,zip:A.zip,country:A.country},guardian:{name:{given:E.given,family:E.family},relationship:B,relationship_code:C,address:F,phone:{home:D}},patient_contacts:K,provider:{ids:J,organization:G,phones:H,address:I}}},d.C32.encounters=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress),f=b.parseIds,g=[];return a.section("encounters").entries().each(function(a){var b=d(a.tag("effectiveTime").attr("value"));b||(b=d(a.tag("effectiveTime").tag("low").attr("value"))),c=a.tag("code");var h=c.attr("displayName"),i=c.attr("code"),j=c.attr("codeSystem"),k=c.attr("codeSystemName"),l=c.attr("codeSystemVersion");c=a.tag("translation");var m=c.attr("displayName"),n=c.attr("code"),o=c.attr("codeSystem"),p=c.attr("codeSystemName");c=a.tag("performer");var q=c.tag("name").val(),r=c.attr("code"),s=c.attr("codeSystem"),t=c.attr("codeSystemName"),u=f(a.tag("performer").tag("assignedEntity").immediateChildrenTags("id"));c=a.tag("participant");var v=c.tag("name").val(),w=e(c);w.organization=v;for(var x=[],y=a.elsByTag("entryRelationship"),z=0;z<y.length;z++)c=y[z].tag("value"),x.push({name:c.attr("displayName"),code:c.attr("code"),code_system:c.attr("codeSystem")});g.push({date:b,name:h,code:i,code_system:j,code_system_name:k,code_system_version:l,findings:x,translation:{name:m,code:n,code_system:o,code_system_name:p},performer:{ids:u,name:q,code:r,code_system:s,code_system_name:t},location:w})}),g},d.C32.immunizations=function(c){var d,e,f=b.parseDate,g=(b.parseName,b.parseAddress,[]),h=[];return c.section("immunizations").entries().each(function(b){d=b.tag("effectiveTime");var c=f(d.attr("value"));c||(c=f(d.tag("low").attr("value"))),d=b.tag("substanceAdministration");var i=d.boolAttr("negationInd");e=b.template("2.16.840.1.113883.10.20.1.53"),d=e.tag("code");var j=d.attr("displayName"),k=d.attr("code"),l=d.attr("codeSystem"),m=d.attr("codeSystemName");d=e.tag("translation");var n=d.attr("displayName"),o=d.attr("code"),p=d.attr("codeSystem"),q=d.attr("codeSystemName");d=e.tag("lotNumberText");var r=d.val();d=e.tag("manufacturerOrganization");var s=d.tag("name").val();d=b.tag("routeCode");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.1.49");var x=a.stripWhitespace(d.tag("text").val());d=d.tag("code");var y=d.attr("displayName"),z=d.attr("code"),A=d.attr("codeSystem");d=b.tag("doseQuantity");var B=d.attr("value"),C=d.attr("unit");(i?h:g).push({date:c,product:{name:j,code:k,code_system:l,code_system_name:m,translation:{name:n,code:o,code_system:p,code_system_name:q},lot_number:r,manufacturer_name:s},dose_quantity:{value:B,unit:C},route:{name:t,code:u,code_system:v,code_system_name:w},instructions:x,education_type:{name:y,code:z,code_system:A}})}),{administered:g,declined:h}},d.C32.results=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,[]);return c.section("results").entries().each(function(b){d=b.tag("effectiveTime");var c=e(b.tag("effectiveTime").attr("value"));c||(c=e(b.tag("effectiveTime").tag("low").attr("value"))),d=b.tag("code");for(var g,h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName"),l=b.elsByTag("observation"),m=[],n=0;n<l.length;n++)if(g=l[n],g.template("2.16.840.1.113883.10.20.1.31").val()){var o=e(g.tag("effectiveTime").attr("value"));d=g.tag("code");var p=d.attr("displayName"),q=d.attr("code"),r=d.attr("codeSystem"),s=d.attr("codeSystemName");p||(p=a.stripWhitespace(g.tag("text").val())),d=g.tag("translation");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");d=g.tag("value");var x=d.attr("value"),y=d.attr("unit");x&&!isNaN(parseFloat(x))&&(x=parseFloat(x)),x||(x=d.val()),d=g.tag("referenceRange");var z=a.stripWhitespace(d.tag("observationRange").tag("text").val()),A=d.tag("observationRange").tag("low").attr("unit"),B=d.tag("observationRange").tag("low").attr("value"),C=d.tag("observationRange").tag("high").attr("unit"),D=d.tag("observationRange").tag("high").attr("value");m.push({date:o,name:p,value:x,unit:y,code:q,code_system:r,code_system_name:s,translation:{name:t,code:u,code_system:v,code_system_name:w},reference_range:{text:z,low_unit:A,low_value:B,high_unit:C,high_value:D}})}f.push({name:h,code:i,code_system:j,code_system_name:k,date:c,tests:m})}),f},d.C32.medications=function(c){var d,e=b.parseDate,f=[];return c.section("medications").entries().each(function(b){var g=b.tag("value").attr("displayName");g||(g=b.tag("statusCode").attr("code"));var h=b.tag("reference").attr("value"),i=b.tag("text").val(),j=null;null!=h&&c.content("sig-"+h.split("-")[1]).val()&&(j=c.content("sig-"+h.split("-")[1]).val());var k=null;d=b.tag("substanceAdministration").immediateChildTag("text"),d.isEmpty()||(k=a.stripWhitespace(d.val()));var l=b.elsByTag("effectiveTime");d=l[0];var m=null,n=null;d&&(m=e(d.tag("low").attr("value")),n=e(d.tag("high").attr("value"))),d=l[1];var o=null,p=null,q=null;if(d&&"PIVL_TS"===d.attr("xsi:type")){var r=d.attr("institutionSpecified");"true"===r?o="frequency":"false"===r&&(o="interval"),d=d.tag("period"),p=d.attr("value"),q=d.attr("unit")}d=b.tag("manufacturedProduct").tag("code");var s=d.attr("displayName"),t=d.attr("code"),u=d.attr("codeSystem"),v=null;d=b.tag("manufacturedProduct").tag("originalText"),d.isEmpty()||(v=a.stripWhitespace(d.val())),!s&&v&&(s=v),s||(d=b.tag("manufacturedProduct").tag("name"),d.isEmpty()||(s=a.stripWhitespace(d.val()))),d=b.tag("manufacturedProduct").tag("translation");var w=d.attr("displayName"),x=d.attr("code"),y=d.attr("codeSystem"),z=d.attr("codeSystemName");d=b.tag("doseQuantity");var A=d.attr("value"),B=d.attr("unit");d=b.tag("rateQuantity");var C=d.attr("value"),D=d.attr("unit");d=b.tag("precondition").tag("value");var E=d.attr("displayName"),F=d.attr("code"),G=d.attr("codeSystem");d=b.template("2.16.840.1.113883.10.20.1.28").tag("value");var H=d.attr("displayName"),I=d.attr("code"),J=d.attr("codeSystem");d=b.tag("routeCode");var K=d.attr("displayName"),L=d.attr("code"),M=d.attr("codeSystem"),N=d.attr("codeSystemName");d=b.tag("participant").tag("playingEntity");var O=d.tag("name").val();d=d.tag("code"),O=d.attr("displayName")||O;var P=d.attr("code"),Q=d.attr("codeSystem"),R=d.attr("codeSystemName");d=b.tag("administrationUnitCode");var S=d.attr("displayName"),T=d.attr("code"),U=d.attr("codeSystem"),V=d.attr("codeSystemName");d=b.tag("performer");var W=d.tag("name").val();f.push({reference:h,reference_title:i,reference_sig:j,date_range:{start:m,end:n},status:g,text:k,product:{name:s,text:v,code:t,code_system:u,translation:{name:w,code:x,code_system:y,code_system_name:z}},dose_quantity:{value:A,unit:B},rate_quantity:{value:C,unit:D},precondition:{name:E,code:F,code_system:G},reason:{name:H,code:I,code_system:J},route:{name:K,code:L,code_system:M,code_system_name:N},schedule:{type:o,period_value:p,period_unit:q},vehicle:{name:O,code:P,code_system:Q,code_system_name:R},administration:{name:S,code:T,code_system:U,code_system_name:V},prescriber:{organization:W,person:null}})}),f},d.C32.payers=function(a){var c=b.parseDate,d=(b.parseName,[]);return a.section("payers").entries().each(function(a){var b=a.tag("act").tag("performer").tag("representedOrganization").tag("name").val(),e=a.tag("act").tag("entryRelationship").tag("act").tag("text").val(),f=a.tag("act").tag("participant").tag("participantRole").tag("id").attr("extension"),g=a.tag("act").tag("participant").tag("participantRole").tag("code").attr("displayName"),h=a.tag("participant").tag("playingEntity").tag("name").val(),i=c(a.tag("act").tag("participant").tag("time").tag("low").attr("value")),j=c(a.tag("act").tag("participant").tag("time").tag("high").attr("value"));h&&(h=h.replace(/(\r\n|\n|\r)/gm,"").replace(/\s+/g," ").replace(/^\s+|\s+$/g,"")),d.push({insurance:b,policy_type:e,policy_id:f,relation:g,subscriber:h,date_range:{start:i,end:j}})}),d},d.C32.problems=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,[]);return c.section("problems").entries().each(function(b){var c=b.tag("reference").attr("value"),g=b.tag("text").val();d=b.tag("effectiveTime");var h=e(d.tag("low").attr("value")),i=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.10.20.1.28").tag("value");var j=d.attr("displayName"),k=d.attr("code"),l=d.attr("codeSystem"),m=d.attr("codeSystemName");j||(d=b.template("2.16.840.1.113883.10.20.1.28").tag("originalText"),d.isEmpty()||(j=a.stripWhitespace(d.val())));var n=b.template("2.16.840.1.113883.10.20.1.28").elsByTag("translation"),o=[];n.isEmpty||(o=n.map(function(a){return{name:a.attr("displayName"),code:a.attr("code"),code_system:a.attr("codeSystem"),code_system_name:a.attr("codeSystemName")}})),d=b.template("2.16.840.1.113883.10.20.1.50");var p=d.tag("value").attr("displayName"),q=null;d=b.template("2.16.840.1.113883.10.20.1.38"),d.isEmpty()||(q=parseFloat(d.tag("value").attr("value"))),f.push({reference:c,reference_title:g,date_range:{start:h,end:i},name:j,status:p,age:q,code:k,code_system:l,code_system_name:m,translations:o,comment:null})}),f},d.C32.procedures=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress),g=[];return c.section("procedures").entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.attr("value"));d=b.tag("code");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem");h||(h=a.stripWhitespace(b.tag("originalText").val())),d=b.tag("specimen").tag("code");var k=d.attr("displayName"),l=d.attr("code"),m=d.attr("codeSystem");d=b.tag("performer").tag("addr");var n=d.tag("name").val(),o=d.tag("telecom").attr("value"),p=f(d);p.organization=n,p.phone=o,d=b.tag("participant").tag("code");var q=d.attr("displayName"),r=d.attr("code"),s=d.attr("codeSystem");g.push({date:c,name:h,code:i,code_system:j,specimen:{name:k,code:l,code_system:m},performer:p,device:{name:q,code:r,code_system:s}})}),g},d.C32.vitals=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress,[]);return a.section("vitals").entries().each(function(a){c=a.tag("effectiveTime");for(var b,f=d(c.attr("value")),g=a.elsByTag("component"),h=[],i=0;i<g.length;i++){b=g[i],c=b.tag("code");var j=c.attr("displayName"),k=c.attr("code"),l=c.attr("codeSystem"),m=c.attr("codeSystemName");c=b.tag("value");var n=parseFloat(c.attr("value")),o=c.attr("unit");h.push({name:j,code:k,code_system:l,code_system_name:m,value:n,unit:o})}e.push({date:f,results:h})}),e},d.CCDA=function(){return{run:function(b){var c={};return c.document=d.CCDA.document(b),c.allergies=d.CCDA.allergies(b),c.care_plan=d.CCDA.care_plan(b),c.chief_complaint=d.CCDA.free_text(b,"chief_complaint"),c.demographics=d.CCDA.demographics(b),c.encounters=d.CCDA.encounters(b),c.functional_statuses=d.CCDA.functional_statuses(b),c.immunizations=d.CCDA.immunizations(b).administered,c.immunization_declines=d.CCDA.immunizations(b).declined,c.instructions=d.CCDA.instructions(b),c.results=d.CCDA.results(b),c.medications=d.CCDA.medications(b),c.payers=d.CCDA.payers(b),c.problems=d.CCDA.problems(b),c.procedures=d.CCDA.procedures(b),c.smoking_status=d.CCDA.smoking_status(b),c.vitals=d.CCDA.vitals(b),c.json=a.json,c.document.json=a.json,c.allergies.json=a.json,c.care_plan.json=a.json,c.chief_complaint.json=a.json,c.demographics.json=a.json,c.encounters.json=a.json,c.functional_statuses.json=a.json,c.immunizations.json=a.json,c.immunization_declines.json=a.json,c.instructions.json=a.json,c.results.json=a.json,c.medications.json=a.json,c.problems.json=a.json,c.payers.json=a.json,c.procedures.json=a.json,c.smoking_status.json=a.json,c.vitals.json=a.json,c}}}(),d.CCDA.document=function(c){var d,e=b.parseDate,f=b.parseName,g=b.parseAddress,h=b.parsePhones,i=b.parseIds,j=c.section("document"),k=e(j.tag("effectiveTime").attr("value")),l=a.stripWhitespace(j.tag("title").val()),m=j.tag("author");m.tag("assignedAuthor").tag("id");d=m.tag("assignedPerson").tag("name");var n=f(d),o=m.tag("assignedAuthor").tag("id").attr("extension");d=m.tag("addr");var p=g(d);d=m.tag("assignedAuthor").immediateChildrenTags("telecom");for(var q=h(d),r=[],s=j.tag("documentationOf").elsByTag("performer"),t=0;t<s.length;t++){d=s[t];var u=f(d),v=h(d.elsByTag("telecom")),w=g(d.tag("addr")),x="ProviderID"==s[t].tag("assignedEntity").tag("id").attr("extension")?s[t].tag("assignedEntity").tag("id").attr("root"):null;r.push({provider_id:x,name:u,phones:v,address:w})}d=j.tag("legalAuthenticator");var y=e(d.tag("time").attr("value")),z=f(d.tag("assignedEntity").tag("assignedPerson").tag("name")),A=g(d.tag("assignedEntity").tag("addr")),B=d.tag("assignedEntity").immediateChildrenTags("id"),C=i(B),D=d.tag("representedOrganization").immediateChildrenTags("id"),E=i(D),F=d.tag("representedOrganization").tag("name").val(),G=d.tag("assignedEntity").immediateChildrenTags("telecom"),H=h(G);d=j.tag("encompassingEncounter").tag("location");var I=a.stripWhitespace(d.tag("name").val()),J=g(d.tag("addr")),K=null;return d=d.tag("effectiveTime"),d.isEmpty()||(K=e(d.attr("value"))),{custodian:{name:j.tag("custodian").tag("assignedCustodian").tag("representedCustodianOrganization").tag("name").val()},date:k,title:l,author:{npi:o,name:n,address:p,phones:q},documentation_of:r,legal_authenticator:{date:y,ids:C,assigned_person:z,representedOrganization:{ids:E,name:F,phones:H,address:A}},location:{name:I,address:J,encounter_date:K}}},d.CCDA.allergies=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,[]);return c.section("allergies").entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.tag("low").attr("value")),g=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.10.20.22.4.7").tag("code");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem"),k=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.7").tag("value");var l=d.attr("displayName"),m=d.attr("code"),n=d.attr("codeSystem"),o=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.9").tag("value");var p=d.attr("displayName"),q=d.attr("code"),r=d.attr("codeSystem");d=b.template("2.16.840.1.113883.10.20.22.4.8").tag("value");var s=d.attr("displayName");d=b.tag("participant").tag("code");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");t||(d=b.tag("participant").tag("name"),d.isEmpty()||(t=d.val())),t||(d=b.template("2.16.840.1.113883.10.20.22.4.7").tag("originalText"),d.isEmpty()||(t=a.stripWhitespace(d.val()))),d=b.template("2.16.840.1.113883.10.20.22.4.28").tag("value");var x=d.attr("displayName");f.push({date_range:{start:c,end:g},name:h,code:i,code_system:j,code_system_name:k,status:x,severity:s,reaction:{name:p,code:q,code_system:r},reaction_type:{name:l,code:m,code_system:n,code_system_name:o},allergen:{name:t,code:u,code_system:v,code_system_name:w}})}),f},d.CCDA.care_plan=function(b){var c,d=[];return b.section("care_plan").entries().each(function(b){var e=null,f=null,g=null,h=null;c=b.template("2.16.840.1.113883.10.20.22.4.40"),c.isEmpty()?(c=b.tag("code"),e=c.attr("displayName"),f=c.attr("code"),g=c.attr("codeSystem"),h=c.attr("codeSystemName")):e="encounter";var i=a.stripWhitespace(b.tag("text").val());d.push({text:i,name:e,code:f,code_system:g,code_system_name:h})}),d},d.CCDA.demographics=function(c){var d,e=b.parseDate,f=b.parseName,g=b.parseAddress,h=b.parsePhones,i=b.parseIds,j=c.section("demographics"),k=j.tag("patientRole");d=k.tag("patient").tag("name");for(var l=f(d),m=k.elsByTag("id"),n=k.tag("id").attr("extension"),o=[],p=0;p<m.length;p++)null!==m[p].attr("assigningAuthorityName")&&("mrn"==m[p].attr("assigningAuthorityName").toLowerCase()&&(n=m[p].attr("extension")),o.push({name:m[p].attr("assigningAuthorityName").toLowerCase(),id:m[p].attr("extension")}));d=k.tag("patient");var q=e(d.tag("birthTime").attr("value")),r=a.Codes.gender(d.tag("administrativeGenderCode").attr("code")),s=a.Codes.maritalStatus(d.tag("maritalStatusCode").attr("code"));d=k.tag("addr");var t=g(d);d=k.immediateChildrenTags("telecom");var u=h(d),v=function(a){if(!a.length>0)return null;for(var b=0;b<a.length;b++){var c=a[b].attr("value");if(null!=c&&c.indexOf("@")>-1){if(c.indexOf(":")>-1){return c.split(":")[1].toString()}return c.toString()}}},w=v(d),x=w||null,y=k.tag("languageCommunication").tag("languageCode").attr("code"),z=k.tag("raceCode").attr("displayName"),A=k.tag("ethnicGroupCode").attr("displayName"),B=k.tag("religiousAffiliationCode").attr("displayName");d=k.tag("birthplace");var C=g(d);d=k.tag("guardian");var D=d.tag("code").attr("displayName"),E=d.tag("code").attr("code"),F=d.tag("telecom").attr("value");d=d.tag("guardianPerson").tag("name");var G=f(d);d=k.tag("guardian").tag("addr");var H=g(d);d=k.tag("providerOrganization");var I=d.tag("name").val(),J=h(d.immediateChildrenTags("telecom")),K=i(d.immediateChildrenTags("id")),L=g(d.tag("addr"));d=j.immediateChildrenTags("participant");var M=d.map(function(b){return b=b.tag("associatedEntity"),{relationship:a.Codes.role(b.attr("classCode")),relationship_code:{code:b.tag("code").attr("code"),displayName:b.tag("code").attr("displayName")},phones:h(b.immediateChildrenTags("telecom")),name:f(b.tag("associatedPerson").tag("name"))}});return{ids:o,name:l,dob:q,gender:r,mrn_number:n,marital_status:s,address:t,phones:u,email:x,language:y,race:z,ethnicity:A,religion:B,birthplace:{state:C.state,zip:C.zip,country:C.country},guardian:{name:{given:G.given,family:G.family},relationship:D,relationship_code:E,address:H,phone:{home:F}},patient_contacts:M,provider:{ids:K,organization:I,phones:J,address:L}}},d.CCDA.encounters=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress),f=b.parseIds,g=[];return a.section("encounters").entries().each(function(a){var b=d(a.tag("effectiveTime").attr("value"));c=a.tag("code");var h=c.attr("displayName"),i=c.attr("code"),j=c.attr("codeSystem"),k=c.attr("codeSystemName"),l=c.attr("codeSystemVersion");c=a.tag("translation");var m=c.attr("displayName"),n=c.attr("code"),o=c.attr("codeSystem"),p=c.attr("codeSystemName");c=a.tag("performer").tag("code");var q=c.attr("displayName"),r=c.attr("code"),s=c.attr("codeSystem"),t=c.attr("codeSystemName"),u=f(a.tag("performer").tag("assignedEntity").immediateChildrenTags("id"));c=a.tag("participant");var v=c.tag("code").attr("displayName"),w=e(c);w.organization=v;for(var x=[],y=a.elsByTag("entryRelationship"),z=0;z<y.length;z++)c=y[z].tag("value"),x.push({name:c.attr("displayName"),code:c.attr("code"),code_system:c.attr("codeSystem")});g.push({date:b,name:h,code:i,code_system:j,code_system_name:k,code_system_version:l,findings:x,translation:{name:m,code:n,code_system:o,code_system_name:p},performer:{ids:u,name:q,code:r,code_system:s,code_system_name:t},location:w})}),g},d.CCDA.free_text=function(b,c){var d=b.section(c);return{text:a.stripWhitespace(d.tag("text").val())}},d.CCDA.functional_statuses=function(a){var c,d=b.parseDate,e=[];return a.section("functional_statuses").entries().each(function(a){var b=d(a.tag("effectiveTime").attr("value"));b||(b=d(a.tag("effectiveTime").tag("low").attr("value"))),c=a.tag("value");var f=c.attr("displayName"),g=c.attr("code"),h=c.attr("codeSystem"),i=c.attr("codeSystemName");e.push({date:b,name:f,code:g,code_system:h,code_system_name:i})}),e},d.CCDA.immunizations=function(c){var d,e,f=b.parseDate,g=(b.parseName,b.parseAddress,[]),h=[];return c.section("immunizations").entries().each(function(b){d=b.tag("effectiveTime");var c=f(d.attr("value"));c||(c=f(d.tag("low").attr("value"))),d=b.tag("substanceAdministration");var i=d.boolAttr("negationInd");e=b.template("2.16.840.1.113883.10.20.22.4.54"),d=e.tag("code");var j=d.attr("displayName"),k=d.attr("code"),l=d.attr("codeSystem"),m=d.attr("codeSystemName");d=e.tag("translation");var n=d.attr("displayName"),o=d.attr("code"),p=d.attr("codeSystem"),q=d.attr("codeSystemName");d=e.tag("lotNumberText");var r=d.val();d=e.tag("manufacturerOrganization");var s=d.tag("name").val();d=b.tag("routeCode");var t=d.attr("displayName"),u=d.attr("code"),v=d.attr("codeSystem"),w=d.attr("codeSystemName");d=b.template("2.16.840.1.113883.10.20.22.4.20");var x=a.stripWhitespace(d.tag("text").val());d=d.tag("code");var y=d.attr("displayName"),z=d.attr("code"),A=d.attr("codeSystem");d=b.tag("doseQuantity");var B=d.attr("value"),C=d.attr("unit");(i?h:g).push({date:c,product:{name:j,code:k,code_system:l,code_system_name:m,translation:{name:n,code:o,code_system:p,code_system_name:q},lot_number:r,manufacturer_name:s},dose_quantity:{value:B,unit:C},route:{name:t,code:u,code_system:v,code_system_name:w},instructions:x,education_type:{name:y,code:z,code_system:A}})}),{administered:g,declined:h}},d.CCDA.instructions=function(b){var c,d=[];return b.section("instructions").entries().each(function(b){c=b.tag("code");var e=c.attr("displayName"),f=c.attr("code"),g=c.attr("codeSystem"),h=c.attr("codeSystemName"),i=a.stripWhitespace(b.tag("text").val());d.push({text:i,name:e,code:f,code_system:g,code_system_name:h})}),d},d.CCDA.results=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,[]);return c.section("results").entries().each(function(b){d=b.tag("code");for(var c,g=d.attr("displayName"),h=d.attr("code"),i=d.attr("codeSystem"),j=d.attr("codeSystemName"),k=b.elsByTag("observation"),l=[],m=0;m<k.length;m++){c=k[m];var n=e(c.tag("effectiveTime").attr("value"));d=c.tag("code");var o=d.attr("displayName"),p=d.attr("code"),q=d.attr("codeSystem"),r=d.attr("codeSystemName");o||(o=a.stripWhitespace(c.tag("text").val())),d=c.tag("translation");var s=d.attr("displayName"),t=d.attr("code"),u=d.attr("codeSystem"),v=d.attr("codeSystemName");d=c.tag("value");var w=d.attr("value"),x=d.attr("unit");w&&!isNaN(parseFloat(w))&&(w=parseFloat(w)),w||(w=d.val()),d=c.tag("referenceRange");var y=a.stripWhitespace(d.tag("observationRange").tag("text").val()),z=d.tag("observationRange").tag("low").attr("unit"),A=d.tag("observationRange").tag("low").attr("value"),B=d.tag("observationRange").tag("high").attr("unit"),C=d.tag("observationRange").tag("high").attr("value");l.push({date:n,name:o,value:w,unit:x,code:p,code_system:q,code_system_name:r,translation:{name:s,code:t,code_system:u,code_system_name:v},reference_range:{text:y,low_unit:z,low_value:A,high_unit:B,high_value:C}})}f.push({name:g,code:h,code_system:i,code_system_name:j,tests:l})}),f},d.CCDA.medications=function(c){var d,e=b.parseDate,f=[];return c.section("medications").entries().each(function(b){var g=b.tag("value").attr("displayName");g||(g=b.tag("statusCode").attr("code"));var h=b.tag("reference").attr("value"),i=b.tag("text").val(),j=null;null!=h&&c.content("sig-"+h.split("-")[1]).val()&&(j=c.content("sig-"+h.split("-")[1]).val()),d=b.tag("text");var k=a.stripWhitespace(d.val()),l=b.elsByTag("effectiveTime");d=l[0];var m=null,n=null;d&&(m=e(d.tag("low").attr("value")),n=e(d.tag("high").attr("value"))),d=l[1];var o=null,p=null,q=null;if(d&&"PIVL_TS"===d.attr("xsi:type")){var r=d.attr("institutionSpecified");"true"===r?o="frequency":"false"===r&&(o="interval"),d=d.tag("period"),p=d.attr("value"),q=d.attr("unit")}d=b.tag("manufacturedProduct").tag("code");var s=d.attr("displayName"),t=d.attr("code"),u=d.attr("codeSystem"),v=null;d=b.tag("manufacturedProduct").tag("originalText"),d.isEmpty()||(v=a.stripWhitespace(d.val())),!s&&v&&(s=v),d=b.tag("manufacturedProduct").tag("translation");var w=d.attr("displayName"),x=d.attr("code"),y=d.attr("codeSystem"),z=d.attr("codeSystemName");d=b.tag("doseQuantity");var A=d.attr("value"),B=d.attr("unit");d=b.tag("rateQuantity");var C=d.attr("value"),D=d.attr("unit");d=b.tag("precondition").tag("value");var E=d.attr("displayName"),F=d.attr("code"),G=d.attr("codeSystem");d=b.template("2.16.840.1.113883.10.20.22.4.19").tag("value");var H=d.attr("displayName"),I=d.attr("code"),J=d.attr("codeSystem");d=b.tag("routeCode");var K=d.attr("displayName"),L=d.attr("code"),M=d.attr("codeSystem"),N=d.attr("codeSystemName");d=b.tag("participant").tag("playingEntity");var O=d.tag("name").val();d=d.tag("code"),O=d.attr("displayName")||O;var P=d.attr("code"),Q=d.attr("codeSystem"),R=d.attr("codeSystemName");d=b.tag("administrationUnitCode");var S=d.attr("displayName"),T=d.attr("code"),U=d.attr("codeSystem"),V=d.attr("codeSystemName");d=b.tag("performer");var W=d.tag("name").val();f.push({reference:h,reference_title:i,reference_sig:j,date_range:{start:m,end:n},status:g,text:k,product:{name:s,code:t,code_system:u,text:v,translation:{name:w,code:x,code_system:y,code_system_name:z}},dose_quantity:{value:A,unit:B},rate_quantity:{value:C,unit:D},precondition:{name:E,code:F,code_system:G},reason:{name:H,code:I,code_system:J},route:{name:K,code:L,code_system:M,code_system_name:N},schedule:{type:o,period_value:p,period_unit:q},vehicle:{name:O,code:P,code_system:Q,code_system_name:R},administration:{name:S,code:T,code_system:U,code_system_name:V},prescriber:{organization:W,person:null}})}),f},d.CCDA.payers=function(a){var c=(b.parseDate,b.parseName,[]);return a.section("payers").entries().each(function(a){var b=a.tag("performer").tag("representedOrganization").tag("name").val(),d=a.tag("participant").tag("code").attr("displayName"),e=a.tag("entryRelationship").tag("id").attr("extension"),f=a.tag("participant").tag("code").attr("code"),g=a.tag("participant").tag("playingEntity").tag("name").val();g&&(g=g.replace(/(\r\n|\n|\r)/gm,"").replace(/\s+/g," ").replace(/^\s+|\s+$/g,"")),c.push({insurance:b,policy_type:d,policy_id:e,relation:f,subscriber:g,date_range:{start:null,end:null}})}),c},d.CCDA.problems=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress,[]);return c.section("problems").entries().each(function(b){var c=b.tag("reference").attr("value"),g=b.tag("text").val();d=b.tag("effectiveTime");var h=e(d.tag("low").attr("value")),i=e(d.tag("high").attr("value"));d=b.template("2.16.840.1.113883.10.20.22.4.4").tag("value");var j=d.attr("displayName"),k=d.attr("code"),l=d.attr("codeSystem"),m=d.attr("codeSystemName"),n=b.template("2.16.840.1.113883.10.20.22.4.4").elsByTag("translation"),o=[];n.isEmpty||(o=n.map(function(a){return{name:a.attr("displayName"),code:a.attr("code"),code_system:a.attr("codeSystem"),code_system_name:a.attr("codeSystemName")}})),d=b.template("2.16.840.1.113883.10.20.22.4.6");var p=d.tag("value").attr("displayName"),q=null;d=b.template("2.16.840.1.113883.10.20.22.4.31"),d.isEmpty()||(q=parseFloat(d.tag("value").attr("value"))),d=b.template("2.16.840.1.113883.10.20.22.4.64");var r=a.stripWhitespace(d.tag("text").val());f.push({reference:c,reference_title:g,date_range:{start:h,end:i},name:j,status:p,age:q,code:k,code_system:l,code_system_name:m,translations:o,comment:r})}),f},d.CCDA.procedures=function(c){var d,e=b.parseDate,f=(b.parseName,b.parseAddress),g=[];return c.section("procedures").entries().each(function(b){d=b.tag("effectiveTime");var c=e(d.attr("value"));d=b.tag("code");var h=d.attr("displayName"),i=d.attr("code"),j=d.attr("codeSystem");h||(h=a.stripWhitespace(b.tag("originalText").val())),d=b.tag("specimen").tag("code");var k=d.attr("displayName"),l=d.attr("code"),m=d.attr("codeSystem");d=b.tag("performer").tag("addr");var n=d.tag("name").val(),o=d.tag("telecom").attr("value"),p=f(d);p.organization=n,p.phone=o,d=b.template("2.16.840.1.113883.10.20.22.4.37").tag("code");var q=d.attr("displayName"),r=d.attr("code"),s=d.attr("codeSystem");g.push({date:c,name:h,code:i,code_system:j,specimen:{name:k,code:l,code_system:m},performer:p,device:{name:q,code:r,code_system:s}})}),g},d.CCDA.smoking_status=function(a){for(var c,d=b.parseDate,e=(b.parseName,b.parseAddress,null),f=null,g=null,h=null,i=null,j=a.section("social_history"),k=j.entries(),l=0;l<k.length;l++){var m=k[l],n=m.template("2.16.840.1.113883.10.20.22.4.78");if(n.isEmpty()&&(n=m.template("2.16.840.1.113883.10.22.4.78")),!n.isEmpty()&&(c=n.tag("effectiveTime"),i=d(c.attr("value")),c=n.tag("value"),e=c.attr("displayName"),f=c.attr("code"),g=c.attr("codeSystem"),h=c.attr("codeSystemName"),e))break}return{date:i,name:e,code:f,code_system:g,code_system_name:h}},d.CCDA.vitals=function(a){var c,d=b.parseDate,e=(b.parseName,b.parseAddress,[]);return a.section("vitals").entries().each(function(a){c=a.tag("effectiveTime");for(var b,f=d(c.attr("value")),g=a.elsByTag("component"),h=[],i=0;i<g.length;i++){b=g[i],c=b.tag("code");var j=c.attr("displayName"),k=c.attr("code"),l=c.attr("codeSystem"),m=c.attr("codeSystemName");c=b.tag("value");var n=parseFloat(c.attr("value")),o=c.attr("unit");h.push({name:j,code:k,code_system:l,code_system_name:m,value:n,unit:o})}e.push({date:f,results:h})}),e};return function(e,f){var g,h,i;if(f||(f={}),h=a.parseData(e),f.parser)i=f.parser();else switch(g=b.detect(h)){case"c32":h=b.C32.process(h),i=d.C32.run(h);break;case"ccda":h=b.CCDA.process(h),i=d.CCDA.run(h);break;case"json":switch(f.generatorType){case"c32":g="c32",i=c.C32.run(h,f.template,f.testingMode);break;case"ccda":g="ccda",i=c.CCDA.run(h,f.template,f.testingMode)}}return{type:g,data:i,source:h}}});